---
title: S-HOOK 동시성 문제 해결
date: 2023-09-07 15:18:41 +0900
updated: 2023-09-07 15:19:24 +0900
tags:
  - shook
  - 레벨4
  - 우테코
  - 개발
  - spring
  - 미완성
---

## 개요

현재 `killing_part_like` 는 문제가 많다.  
아무튼... 좀 이따 자세히 쓰겠다.

## 너무 느린 API 응답

### Locust 로 API 응답 측정

## DB 가 느린걸까, 애플리케이션 처리 속도가 느린 걸까

### 어떻게 측정할 수 있을까

### 그래서 어떤 게 느릴까

## 현재 우리의 좋아요 정책

- 메인에서 좋아요 순으로 정렬된 데이터를 가져온다. 현재는 서버에서 특정 기간(1시간, 30분 등)으로 캐싱하지 않고 매번 실시간으로 정렬해서 조회한다.
- 유저가 각 노래의 킬링파트에 좋아요를 누르면 메인의 좋아요 순위가 변경될 수 있다.
- 각 노래의 킬링파트에 유저들의 좋아요한 개수, 내가 좋아요를 눌렀는지 여부가 표시된다.
- 어떤 노래를 들어가서 스와이프를 했을 때, 앞 뒤로 좋아요 순으로 정렬된 데이터를 각각 10개씩 받아온다.

### 발생할 수 있는 문제점

1. **여러 유저가 어떤 노래의 킬링파트에 대해 동시에 좋아요를 눌렀을 때, 동시성 문제가 발생할 수 있다.** => 매우 시급

2. 동시성 이슈를 고려하지 않는다고 했을 때 -> 유저가 좋아요를 눌렀을 때, DB의 킬링파트 좋아요가 추가되기 때문에 기존에 사용자가 메인에서 보았던 좋아요 순 노래 리스트가 변경될 수 있다. 즉, 기존에 들었던 노래가 스와이프 했을 때 다시 등장할 수도 있다.  => 꽤나 시급

3. 좋아요 수를 실시간으로 반영하기 때문에 응답을 캐싱하는 것이 불가능하다.

정렬 방식이 있긴 해야 되는데 좀 실시간으로 안 변하는 수치였으면 좋겠다...  

- 주간 좋아요 순
	- where 기간 사이만 보면 되니까 변하지 않는 데이터가 될 듯.
- 전날 좋아요 순
	- 어제 것만 보면 되니까...?
